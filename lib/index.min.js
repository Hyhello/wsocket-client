/*!
 * socketjs v0.0.1
 * @license (c) 2021-2023 hyhello <673089899@qq.com>
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SocketJS=e()}(this,(function(){"use strict";var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};var e=function(){return e=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},e.apply(this,arguments)},n=function(){function t(){this.isRuning=!1,this.taps=[]}return t.prototype.enqueue=function(t){var e=this.size();this.taps[e]=t,this.dequeue()},t.prototype.dequeue=function(){var t=this;if(this.size()&&!this.isRuning){this.isRuning=!0;var e=this.taps.shift();null==e||e.fn(null==e?void 0:e.data,(function(){t.isRuning=!1,t.dequeue()}))}},t.prototype.clear=function(){this.taps=[],this.isRuning=!1},t.prototype.size=function(){return this.taps.length},t}(),i={protocols:void 0,networkWatch:!0,heartbeat:!0,heartbeatInterval:3e3,heartbeatPingText:"ping",heartbeatPongText:"pong",heartbeatTimeout:1e4,reconnect:!0,reconnectInterval:5e3,allowReconnectMaxTimes:3},o=function(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)},r=function(){function t(){this.listeners={}}return t.prototype.$emit=function(t){for(var e=this,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var o=this.listeners[t]||[];o.forEach((function(t){t.apply(e,n)}))},t.prototype.$on=function(t,e){o(e),this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e)},t.prototype.$off=function(t,e){o(e);var n=this.listeners[t];Array.isArray(n)&&(this.listeners[t]=n.filter((function(t){return t!==e})))},t.prototype.$once=function(t,e){var n=this;o(e);var i=function(){for(var o=[],r=0;r<arguments.length;r++)o[r]=arguments[r];e.apply(void 0,o),n.$off(t,i)};this.$on(t,i)},t}(),s=function(){function t(t,e){this.disabled=window.navigator.onLine,this.disabled="onLine"in window.navigator&&t,this.onnetchange=e}return t.prototype._bindEvent=function(){window.addEventListener("online",this,!1),window.addEventListener("offline",this,!1)},t.prototype._unbindEvent=function(){window.removeEventListener("online",this,!1),window.removeEventListener("offline",this,!1)},t.prototype.handleEvent=function(t){this.onnetchange(t.type)},t.prototype.start=function(){this.disabled&&this._bindEvent()},t.prototype.end=function(){this._unbindEvent()},t}(),a=function(){function t(t){this._ltimer=0,this._ttimer=0,this.disabled=t.disabled||!1,this.$opts=t,this.isRuning=!1}return t.prototype._destroy=function(t){var e=this;(t?[t]:["_ltimer","_ttimer"]).forEach((function(t){e[t]&&(window.clearTimeout(e[t]),e[t]=0)}))},t.prototype._looper=function(){var t=this,e=this.$opts,n=e.context,i=e.heartbeatPingText,o=e.heartbeatInterval;this._destroy("_ltimer"),n.send(JSON.stringify({type:i})),this._ltimer=window.setTimeout((function(){t._looper()}),o)},t.prototype._timeout=function(){var t=this,e=this.$opts,n=e.context,i=e.heartbeatTimeout;this._destroy("_ttimer"),this._ttimer=window.setTimeout((function(){var e;t._destroy("_ltimer"),null===(e=n.instance)||void 0===e||e.close(4001,"HEARTBEAT FAIL")}),i)},t.prototype.start=function(){if(!this.disabled)return this.isRuning=!0,this._looper(),this._timeout(),this},t.prototype.restart=function(){if(!this.disabled&&this.isRuning)return this._timeout(),this},t.prototype.end=function(){if(!this.disabled&&this.isRuning)return this.isRuning=!1,this._destroy(),this},t}(),c=1;return function(o){function r(t,h){var u=o.call(this)||this;if(u.$id="socket_"+c++,u.instance=null,u._rtimer=0,u._reconnectTimes=0,u instanceof r||console.error("SocketJS is a constructor and should be called with the `new` keyword"),!t)throw new Error("socket\u94fe\u63a5\u5730\u5740\u4e0d\u80fd\u4e3a\u7a7a");return u.$url=t,u.$opts=e(e({},i),h),u._q=new n,u._heartbeat=new a({disabled:!u.$opts.heartbeat,heartbeatInterval:u.$opts.heartbeatInterval,heartbeatPingText:u.$opts.heartbeatPingText,heartbeatTimeout:u.$opts.heartbeatTimeout,context:u}),u._network=new s(!u.$opts.networkWatch,(function(t){"online"===t?u._heartbeat.start():u._heartbeat.end()})),u}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}(r,o),Object.defineProperty(r.prototype,"readyState",{get:function(){return this.instance?this.instance.readyState:0},enumerable:!1,configurable:!0}),r.prototype._reconnect=function(){var t=this,e=this.$opts,n=e.reconnect,i=e.reconnectInterval,o=e.allowReconnectMaxTimes;if(n){if(this._reconnectTimes>=o)return this._clear(),this._reconnectTimes=0,console.error("\u5f53\u524d\u8fde\u63a5\u6b21\u6570\u5df2\u8fbe\u5230\u6700\u5927\uff1a"+o);this._rtimer&&(window.clearTimeout(this._rtimer),this._rtimer=0),this._rtimer=window.setTimeout((function(){t._reconnectTimes++,t.connect()}),i)}},r.prototype._clear=function(){this._heartbeat.end(),this._network.end(),this._q.clear(),this.instance=null},r.prototype._bindEvent=function(){var t=this;if(!this.instance)return this;this.instance.onclose=function(e){t.$emit("close",e),t._clear(),1e3!==e.code?t._reconnect():(t._rtimer&&(window.clearTimeout(t._rtimer),t._rtimer=0),t._reconnectTimes=0)},this.instance.onerror=function(e){t.$emit("error",e)},this.instance.onopen=function(e){t._heartbeat.start(),t._network.start(),t.$emit("open",e)},this.instance.onmessage=function(e){var n=t.$opts,i=n.heartbeatPingText,o=n.heartbeatPongText,r=JSON.stringify({type:i}),s=JSON.stringify({type:o});t._heartbeat.restart(),(!t._heartbeat.isRuning||e.data!==r&&e.data!==s)&&t.$emit("message",e)}},r.prototype.connect=function(){if(!WebSocket)return console.error("\u5f53\u524d\u6d4f\u89c8\u5668\u4e0d\u652f\u6301WebSocket\u534f\u8bae\uff0c\u5efa\u8bae\u4f7f\u7528\u73b0\u5728\u6d4f\u89c8\u5668");if(this.instance)return this;try{this.instance=new WebSocket(this.$url,this.$opts.protocols),this._bindEvent()}catch(t){this._reconnect(),console.error(t)}return this},r.prototype.send=function(t){var e=this.instance,n=this.readyState;if(e&&n===WebSocket.OPEN){var i=function(t,n){0===e.bufferedAmount?(e.send(t),n()):setTimeout(i,10,t,n)};this._q.enqueue({data:t,fn:i})}return this},r.prototype.close=function(){return this.instance?(this.instance.close(),this):this},r}(r)}));
